"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[919],{91696:function(e,a,t){t.d(a,{j:function(){return c}});var o=t(2265),r=t(11713),s=t(1072),i=t(95443),n=t(14362);function c(){let{user:e}=(0,n.a)(),[a,t]=(0,o.useState)("operador"),{data:c,isLoading:d,refetch:l}=(0,r.a)({queryKey:["user-role",null==e?void 0:e.id],queryFn:async()=>{if(!(null==e?void 0:e.id))return null;let{data:a,error:t}=await s.O.from("user_settings").select("role").eq("user_id",e.id).single();if(t){if(console.error("Erro ao buscar role do usu\xe1rio:",t),"PGRST116"===t.code){let{data:a,error:t}=await s.O.from("user_settings").insert({user_id:e.id,role:"operador"}).select("role").single();return t?(console.error("Erro ao criar user_settings:",t),"operador"):a.role}return"operador"}return(null==a?void 0:a.role)||"operador"},enabled:!!(null==e?void 0:e.id),staleTime:3e5});(0,o.useEffect)(()=>{c&&t(c)},[c]);let u=i.IC[a],m="admin"===a&&(null==e?void 0:e.email)==="fmbp1981@gmail.com";return{role:a,permissions:u,isLoading:d,isAdmin:m,isOperador:"operador"===a,isVisualizador:"visualizador"===a,hasPermission:e=>u[e],refetch:l}}},55112:function(e,a,t){t.d(a,{gZ:function(){return u}});var o=t(1072);let r={NOVO:"Novo",NOVO_LEAD:"Novo Lead",CONTATO_INICIAL:"Contato Inicial",QUALIFICACAO:"Qualifica\xe7\xe3o",PROPOSTA_ENVIADA:"Proposta Enviada",NEGOCIACAO:"Negocia\xe7\xe3o",FECHADO_GANHO:"Fechado Ganho",FECHADO_PERDIDO:"Fechado Perdido",EM_FOLLOWUP:"Em Follow-up"},s={NOT_SENT:"not_sent",SENT:"sent"},i={MEDIA:"M\xe9dia"},n={PROSPECCAO_ATIVA:"Prospec\xe7\xe3o Ativa",GOOGLE_PLACES:"Google Places"};function c(e){return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g,"").trim()}async function d(e,a,t){try{let r=c(e);if(a&&a.trim()){let e=a.replace(/\D/g,""),{data:t}=await o.O.from("leads_prospeccao").select("*").or("whatsapp.ilike.%".concat(e,"%,telefone.ilike.%").concat(e,"%")).limit(1);if(t&&t.length>0)return{isDuplicate:!0,existingLead:l(t[0]),message:"Lead com este telefone/WhatsApp j\xe1 existe"}}if(t&&t.trim()){let e=t.replace(/^https?:\/\//,"").replace(/\/$/,"").toLowerCase(),{data:a}=await o.O.from("leads_prospeccao").select("*").ilike("website","%".concat(e,"%")).limit(1);if(a&&a.length>0)return{isDuplicate:!0,existingLead:l(a[0]),message:"Lead com este website j\xe1 existe"}}let{data:s}=await o.O.from("leads_prospeccao").select("*").or("lead.ilike.%".concat(r,"%,empresa.ilike.%").concat(r,"%")).limit(5);if(s&&s.length>0)for(let e of s){let a=c(e.lead||""),t=c(e.empresa||"");if(a===r||t===r)return{isDuplicate:!0,existingLead:l(e),message:"Lead com nome similar j\xe1 existe"}}return{isDuplicate:!1,message:"Lead \xfanico"}}catch(e){return console.error("Erro ao verificar duplicata:",e),{isDuplicate:!1,message:"Erro na verifica\xe7\xe3o"}}}function l(e){return{id:e.id,lead:e.lead||"",status:e.status||r.NOVO,data:e.data||"",empresa:e.empresa||"",categoria:e.categoria||"",contato:e.contato||"",whatsapp:e.whatsapp||"",telefone:e.telefone||"",email:e.email||"",website:e.website||"",instagram:e.instagram||"",cidade:e.cidade||"",endereco:e.endereco||"",bairro:e.bairro||"",bairroRegiao:e.bairro_regiao||"",linkGMN:e.link_gmn||"",aceitaCartao:e.aceita_cartao||"",cnpj:e.cnpj||"",mensagemWhatsApp:e.mensagem_whatsapp||"",statusMsgWA:e.status_msg_wa||s.NOT_SENT,dataEnvioWA:e.data_envio_wa||null,resumoAnalitico:e.resumo_analitico||"",createdAt:e.created_at||new Date().toISOString(),updatedAt:e.updated_at||new Date().toISOString(),origem:n.PROSPECCAO_ATIVA,prioridade:i.MEDIA,regiao:e.cidade||"",segmento:e.categoria||"",ticketMedioEstimado:0,contatoPrincipal:e.contato||"",dataContato:e.created_at||new Date().toISOString(),observacoes:""}}let u={syncAllLeads:async function(){try{let{data:e,error:a}=await o.O.from("leads_prospeccao").select("*").order("created_at",{ascending:!1});if(a)throw a;let t=(e||[]).map(e=>({id:e.id,lead:e.lead||"",status:e.status||r.NOVO,data:e.data||"",empresa:e.empresa||"",categoria:e.categoria||"",contato:e.contato||"",whatsapp:e.whatsapp||"",telefone:e.telefone||"",email:e.email||"",website:e.website||"",instagram:e.instagram||"",cidade:e.cidade||"",endereco:e.endereco||"",bairro:e.bairro||"",bairroRegiao:e.bairro_regiao||"",linkGMN:e.link_gmn||"",aceitaCartao:e.aceita_cartao||"",cnpj:e.cnpj||"",mensagemWhatsApp:e.mensagem_whatsapp||"",statusMsgWA:e.status_msg_wa||s.NOT_SENT,dataEnvioWA:e.data_envio_wa||null,resumoAnalitico:e.resumo_analitico||"",createdAt:e.created_at||new Date().toISOString(),updatedAt:e.updated_at||new Date().toISOString(),origem:n.PROSPECCAO_ATIVA,prioridade:i.MEDIA,regiao:e.cidade||"",segmento:e.categoria||"",ticketMedioEstimado:0,contatoPrincipal:e.contato||"",dataContato:e.created_at||new Date().toISOString(),observacoes:""}));return{success:!0,leads:t}}catch(e){return console.error("Erro ao sincronizar leads:",e),{success:!1,leads:[],message:e.message||"Erro ao carregar leads do banco de dados"}}},updateLead:async function(e,a){try{let t={};void 0!==a.lead&&(t.lead=a.lead),void 0!==a.status&&(t.status=a.status),void 0!==a.empresa&&(t.empresa=a.empresa),void 0!==a.categoria&&(t.categoria=a.categoria),void 0!==a.contato&&(t.contato=a.contato),void 0!==a.whatsapp&&(t.whatsapp=a.whatsapp),void 0!==a.telefone&&(t.telefone=a.telefone),void 0!==a.email&&(t.email=a.email),void 0!==a.cidade&&(t.cidade=a.cidade),void 0!==a.endereco&&(t.endereco=a.endereco),void 0!==a.bairro&&(t.bairro=a.bairro),void 0!==a.bairroRegiao&&(t.bairro_regiao=a.bairroRegiao),void 0!==a.website&&(t.website=a.website),void 0!==a.instagram&&(t.instagram=a.instagram),void 0!==a.linkGMN&&(t.link_gmn=a.linkGMN),void 0!==a.aceitaCartao&&(t.aceita_cartao=a.aceitaCartao),void 0!==a.mensagemWhatsApp&&(t.mensagem_whatsapp=a.mensagemWhatsApp),void 0!==a.statusMsgWA&&(t.status_msg_wa=a.statusMsgWA),void 0!==a.dataEnvioWA&&(t.data_envio_wa=a.dataEnvioWA),void 0!==a.resumoAnalitico&&(t.resumo_analitico=a.resumoAnalitico),void 0!==a.cnpj&&(t.cnpj=a.cnpj),void 0!==a.data&&(t.data=a.data),t.updated_at=new Date().toISOString();let{error:r}=await o.O.from("leads_prospeccao").update(t).eq("id",e);if(r)throw r;return{success:!0,message:"Lead atualizado com sucesso"}}catch(e){return console.error("Erro ao atualizar lead:",e),{success:!1,message:e.message||"Erro ao atualizar lead"}}},updateLeadStatus:async function(e,a){try{let{error:t}=await o.O.from("leads_prospeccao").update({status:a,estagio_pipeline:a,updated_at:new Date().toISOString()}).eq("id",e);if(t)throw t;return{success:!0,message:"Status atualizado para ".concat(a)}}catch(e){return console.error("Erro ao atualizar status:",e),{success:!1,message:e.message||"Erro ao atualizar status"}}},createLead:async function(e){try{let a=await d(e.lead||e.empresa||"",e.whatsapp,e.website);if(a.isDuplicate)return{success:!1,message:a.message};let t=e.status||r.NOVO_LEAD,{data:i,error:n}=await o.O.from("leads_prospeccao").insert({id:crypto.randomUUID(),lead:e.lead||"Lead-000",status:t,estagio_pipeline:t,empresa:e.empresa||"",categoria:e.categoria,contato:e.contatoPrincipal,whatsapp:e.whatsapp,telefone:e.telefone,email:e.email,cidade:e.cidade,endereco:e.endereco,bairro:e.bairro,bairro_regiao:e.bairroRegiao,website:e.website,instagram:e.instagram,link_gmn:e.linkGMN,aceita_cartao:e.aceitaCartao,mensagem_whatsapp:e.mensagemWhatsApp||"",status_msg_wa:e.statusMsgWA||s.NOT_SENT,resumo_analitico:e.resumoAnalitico,cnpj:e.cnpj,data:e.data||new Date().toISOString()}).select().single();if(n)throw n;return{success:!0,leadId:i.id,message:"Lead criado com sucesso"}}catch(e){return console.error("Erro ao criar lead:",e),{success:!1,message:e.message||"Erro ao criar lead"}}},getMetrics:async function(){try{let{data:e,error:a}=await o.O.from("leads_prospeccao").select("*");if(a)throw a;let t=(null==e?void 0:e.length)||0,i={[r.NOVO_LEAD]:0,[r.CONTATO_INICIAL]:0,[r.QUALIFICACAO]:0,[r.PROPOSTA_ENVIADA]:0,[r.NEGOCIACAO]:0,[r.FECHADO_GANHO]:0,[r.FECHADO_PERDIDO]:0,[r.EM_FOLLOWUP]:0,Fechado:0,"Follow-up":0},c={},d=0,l=0;null==e||e.forEach(e=>{let a=e.status||r.NOVO_LEAD;a in i&&i[a]++;let t=e.categoria||n.GOOGLE_PLACES;c[t]=(c[t]||0)+1,d+=0,e.status_msg_wa===s.SENT&&l++});let u=t>0?i[r.FECHADO_GANHO]/t*100:0,m={totalLeads:t,novoLeads:i[r.NOVO_LEAD],emNegociacao:i[r.NEGOCIACAO],fechadoGanho:i[r.FECHADO_GANHO],fechadoPerdido:i[r.FECHADO_PERDIDO],taxaConversao:u,ticketMedioTotal:d,leadsPorStatus:i,leadsPorOrigem:c,leadsPorRegiao:{},leadsPorSegmento:{},mensagensEnviadas:l,mensagensPendentes:t-l,proximosFollowUps:[]};return{success:!0,metrics:m}}catch(e){return console.error("Erro ao calcular m\xe9tricas:",e),{success:!1,message:e.message||"Erro ao calcular m\xe9tricas"}}},getLeadsForWhatsApp:async function(e){try{let{data:a,error:t}=await o.O.from("leads_prospeccao").select("*").in("id",e);if(t)throw t;let c=(a||[]).map(e=>({id:e.id,lead:e.lead||"",status:e.status||r.NOVO_LEAD,empresa:e.empresa||"",categoria:e.categoria||"",contato:e.contato||"",whatsapp:e.whatsapp||"",telefone:e.telefone||"",email:e.email||"",cidade:e.cidade||"",endereco:e.endereco||"",bairro:e.bairro||"",bairroRegiao:e.bairro_regiao||"",website:e.website||"",instagram:e.instagram||"",linkGMN:e.link_gmn||"",aceitaCartao:e.aceita_cartao||"",mensagemWhatsApp:e.mensagem_whatsapp||"",statusMsgWA:e.status_msg_wa||s.NOT_SENT,dataEnvioWA:e.data_envio_wa||null,resumoAnalitico:e.resumo_analitico||"",cnpj:e.cnpj||"",data:e.data||"",origem:n.GOOGLE_PLACES,prioridade:i.MEDIA,regiao:e.cidade||"",segmento:e.categoria||"",ticketMedioEstimado:0,contatoPrincipal:e.contato||"",dataContato:e.created_at||new Date().toISOString(),observacoes:""}));return{success:!0,leads:c}}catch(e){return console.error("Erro ao buscar leads para WhatsApp:",e),{success:!1,leads:[],message:e.message||"Erro ao buscar leads"}}},deleteLeads:async function(e){try{if(!e||0===e.length)return{success:!1,message:"Nenhum lead selecionado"};let{error:a}=await o.O.from("leads_prospeccao").delete().in("id",e);if(a)throw a;return{success:!0,message:"".concat(e.length," leads exclu\xeddos com sucesso")}}catch(e){return console.error("Erro ao excluir leads:",e),{success:!1,message:e.message||"Erro ao excluir leads"}}},checkDuplicateLead:d,mergeLeads:async function(e,a){try{let{data:t,error:r}=await o.O.from("leads_prospeccao").select("*").in("id",[e,a]);if(r||!t||2!==t.length)return{success:!1,message:"N\xe3o foi poss\xedvel encontrar os leads para mesclar"};let s=t.find(a=>a.id===e),i=t.find(e=>e.id===a);if(!s||!i)return{success:!1,message:"Leads n\xe3o encontrados"};let n={lead:s.lead||i.lead,empresa:s.empresa||i.empresa,categoria:s.categoria||i.categoria,contato:s.contato||i.contato,whatsapp:s.whatsapp||i.whatsapp,telefone:s.telefone||i.telefone,email:s.email||i.email,website:s.website||i.website,instagram:s.instagram||i.instagram,cidade:s.cidade||i.cidade,endereco:s.endereco||i.endereco,bairro:s.bairro||i.bairro,link_gmn:s.link_gmn||i.link_gmn,resumo_analitico:s.resumo_analitico||i.resumo_analitico,updated_at:new Date().toISOString()},{error:c}=await o.O.from("leads_prospeccao").update(n).eq("id",e);if(c)throw c;let{error:d}=await o.O.from("leads_prospeccao").delete().eq("id",a);if(d)throw d;return{success:!0,message:"Leads mesclados com sucesso"}}catch(e){return console.error("Erro ao mesclar leads:",e),{success:!1,message:e.message}}},clearLeadHistory:async function(e){try{let{error:a}=await o.O.from("leads_prospeccao").update({mensagem_whatsapp:null,status_msg_wa:s.NOT_SENT,data_envio_wa:null,resumo_analitico:null,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw a;return{success:!0,message:"Hist\xf3rico do lead limpo com sucesso"}}catch(e){return console.error("Erro ao limpar hist\xf3rico:",e),{success:!1,message:e.message}}}}},95443:function(e,a,t){t.d(a,{IC:function(){return o},JS:function(){return s},Sx:function(){return r},pm:function(){return i}});let o={admin:{canCreate:!0,canUpdate:!0,canDelete:!0,canBulkDelete:!0,canExport:!0,canSendWhatsApp:!0,canManageRoles:!0,canViewAuditLogs:!0,canManageIntegrations:!0},operador:{canCreate:!0,canUpdate:!0,canDelete:!0,canBulkDelete:!1,canExport:!0,canSendWhatsApp:!0,canManageRoles:!1,canViewAuditLogs:!1,canManageIntegrations:!1},visualizador:{canCreate:!1,canUpdate:!1,canDelete:!1,canBulkDelete:!1,canExport:!0,canSendWhatsApp:!1,canManageRoles:!1,canViewAuditLogs:!1,canManageIntegrations:!1}},r={admin:"Administrador",operador:"Operador",visualizador:"Visualizador"},s={admin:"Acesso total ao sistema, incluindo gerenciamento de usu\xe1rios e configura\xe7\xf5es",operador:"Pode criar, editar e deletar leads. N\xe3o pode fazer altera\xe7\xf5es em massa",visualizador:"Apenas visualiza\xe7\xe3o e exporta\xe7\xe3o de dados. Sem permiss\xf5es de escrita"},i={admin:"bg-purple-500",operador:"bg-blue-500",visualizador:"bg-gray-500"}}}]);